name: Release

on:
  repository_dispatch:
    types: [release]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (tag or branch)'
        required: true
      version:
        description: 'Version (e.g., 0.1.0 or 0.1.0-beta.1)'
        required: true
      offline:
        description: 'Build offline version'
        type: boolean
        default: false

concurrency:
  group: release-${{ github.event.client_payload.version || inputs.version }}
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.params.outputs.ref }}
      version: ${{ steps.params.outputs.version }}
      offline: ${{ steps.params.outputs.offline }}
    steps:
      - name: Get parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ref=${{ github.event.client_payload.ref }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "offline=${{ github.event.client_payload.offline || 'false' }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "offline=${{ inputs.offline }}" >> $GITHUB_OUTPUT
          fi
          echo "::notice::version=${{ github.event_name == 'repository_dispatch' && github.event.client_payload.version || inputs.version }}"

  # ============================================
  # macOS Build (arm64 only for now)
  # ============================================
  build-macos:
    needs: prepare
    runs-on: macos-14
    timeout-minutes: 90
    steps:
      - name: Checkout source (private repo)
        uses: actions/checkout@v4
        with:
          repository: daymade/flowzero
          token: ${{ secrets.FLOWZERO_REPO_TOKEN }}
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/Library/Caches/electron
          key: ${{ runner.os }}-arm64-electron-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-arm64-electron-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          SKIP_INSTALL_CONFIRM: '1'

      - name: Lint
        run: pnpm lint
        continue-on-error: true

      - name: Test
        run: pnpm test

      - name: Import Apple certificates
        if: ${{ env.HAS_CERT == 'true' }}
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MACOS_CERT_P12 }}
          p12-password: ${{ secrets.MACOS_CERT_PASSWORD }}
        env:
          HAS_CERT: ${{ secrets.MACOS_CERT_P12 != '' }}

      - name: Verify signing identity
        if: ${{ env.HAS_CERT == 'true' }}
        env:
          HAS_CERT: ${{ secrets.MACOS_CERT_P12 != '' }}
        run: |
          echo "=== Keychain search list ==="
          security list-keychains -d user
          echo "=== Valid signing identities ==="
          security find-identity -v signing_temp.keychain
          echo "=== All keychains identity search ==="
          security find-identity -v

      - name: Prepare API key
        if: ${{ env.HAS_API_KEY == 'true' }}
        run: |
          echo "${{ secrets.APPLE_API_KEY }}" | base64 --decode > /tmp/AuthKey.p8
        env:
          HAS_API_KEY: ${{ secrets.APPLE_API_KEY != '' }}

      - name: Prepare offline bundle
        if: ${{ needs.prepare.outputs.offline == 'true' }}
        run: pnpm -C apps/desktop run prepare:offline

      - name: Build
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
          FLOWZERO_OFFLINE_BUNDLE: ${{ needs.prepare.outputs.offline == 'true' && 'true' || '' }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          FLOWZERO_CODESIGN: ${{ secrets.MACOS_CERT_P12 != '' && '1' || '' }}
          FLOWZERO_NOTARIZE: ${{ secrets.APPLE_API_KEY != '' && '1' || '' }}
          APPLE_API_KEY_PATH: /tmp/AuthKey.p8
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
          # Code signing: explicit keychain
          MACOS_SIGNING_KEYCHAIN: signing_temp.keychain
        run: |
          # Raise file descriptor limit for osx-sign walkAsync
          # (PyTorch headers in python-runtime create thousands of files)
          ulimit -n 65536
          echo "[CI] Build started at $(date -u)"
          pnpm -C apps/desktop run forge:make -- --arch=arm64
          echo "[CI] Build completed at $(date -u)"

      - name: List build outputs
        run: find apps/desktop/out/make -type f | head -50

      - name: Upload macOS arm64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-macos-arm64
          retention-days: 3
          path: |
            apps/desktop/out/make/**/*.dmg
            apps/desktop/out/make/**/*.zip

  # ============================================
  # Create Release
  # ============================================
  release:
    needs: [prepare, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List all artifacts
        run: find artifacts -type f | sort

      - name: Determine release type
        id: release_type
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          if [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-alpha"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Flowzero v${{ needs.prepare.outputs.version }}
          prerelease: ${{ steps.release_type.outputs.prerelease }}
          body: |
            ## Flowzero v${{ needs.prepare.outputs.version }}

            ### Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | macOS | Apple Silicon (arm64) | `Flowzero-*-arm64.dmg` |

            ### Auto-Update

            - **Stable**: `https://updates.flowzero.app`
            - **Beta**: `https://updates-beta.flowzero.app`
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip

      - name: Delete artifacts after release
        uses: geekyeggo/delete-artifact@v5
        with:
          name: release-macos-arm64
